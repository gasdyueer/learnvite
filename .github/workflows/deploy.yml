# 构建 VitePress 站点并将其部署到 GitHub Pages 的示例工作流程
# (修改为使用 git push 部署，并使用您自定义的 secrets.GH_TOKEN)
name: Deploy VitePress site to Pages (via git push with custom GH_TOKEN)

on:
  push:
    branches: [main]
  workflow_dispatch:

# 设置 GITHUB_TOKEN 的权限
# 这里只需要读取权限，因为推送将使用您自定义的 GH_TOKEN
permissions:
  contents: read # 只需读取权限，因为我们不依赖内置的 GITHUB_TOKEN 来进行推送
  # pages: write # 不再需要，因为我们不使用 actions/deploy-pages
  # id-token: write # 不再需要，因为我们不使用 actions/deploy-pages

# 只允许同时进行一次部署
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build with VitePress
        run: npm run docs:build

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Deploy to GitHub Pages
        env:
          # 将您手动创建的 secret 命名为 GH_TOKEN
          GH_TOKEN: ${{ secrets.GH_TOKEN }} 
        run: |
          # 假设 VitePress 构建到 docs/.vitepress/dist
          cd docs/.vitepress/dist

          git init
          git add -A
          git commit -m "Deploy VitePress site via GitHub Actions"
          
          # 推送到 gh-pages 分支，强制覆盖
          # 注意：请确保 secrets.GH_TOKEN 具有推送到此仓库的权限
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages -f

# 重要的注意事项：
# 1. 您必须在 GitHub 仓库的 Settings -> Secrets and variables -> Actions -> Repository secrets 中
#    创建一个名为 `GH_TOKEN` 的 secret，其值是您的 Personal Access Token (PAT)。
# 2. 该 PAT 必须具有足够的权限来推送到您的仓库（通常是 `repo` 作用域）。
# 3. 在您的仓库设置中，请确保 GitHub Pages 的源已设置为 `gh-pages` 分支。
